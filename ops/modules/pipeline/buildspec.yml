version: 0.2

phases:
  pre_build:
    commands:
      - pip install awscli --upgrade --user
      - echo "$(aws --version)"
      - echo Logging in to Amazon ECR...
      - aws ecr get-login-password --region ${region} | docker login --username AWS --password-stdin ${ecr_repository_url}
      - echo Entered the pre_build phase...
  build:
    commands:
      - echo Build started on "$(date)"
      - IMAGE_TAG=$(echo "$CODEBUILD_RESOLVED_SOURCE_VERSION" | cut -c 1-7)
      - echo Logging in to Dockerhub
      - echo "$${DOCKER_PASSWORD}" | docker login -u "$${DOCKER_USERNAME}" --password-stdin
      - echo Building the Docker image...
      - REPOSITORY_URI=${ecr_project_uri}
      - docker build --build-arg RAILS_ENV=${rails_env} -t "$REPOSITORY_URI:latest" .
      - docker tag "$REPOSITORY_URI:latest" "$REPOSITORY_URI:$IMAGE_TAG"
  post_build:
    commands:
      - echo Build completed on "$(date)"
      - IMAGE_TAG=$(echo "$CODEBUILD_RESOLVED_SOURCE_VERSION" | cut -c 1-7)
      - REPOSITORY_URI=${ecr_project_uri}
      - echo Pushing the Docker images...
      - docker push "$REPOSITORY_URI:latest"
      - docker push "$REPOSITORY_URI:$IMAGE_TAG"
      - echo Writing image definitions file...
      - printf '[{"name":"application","imageUri":"%s"}]' "$REPOSITORY_URI:$IMAGE_TAG" > imagedefinitions.json
      - echo Writing sidekiq image definitions file...
      - printf '[{"name":"sidekiq","imageUri":"%s"}]' "$REPOSITORY_URI:$IMAGE_TAG" > imagedefinitions_sidekiq.json

artifacts:
  files:
    - imagedefinitions.json
    - imagedefinitions_sidekiq.json
